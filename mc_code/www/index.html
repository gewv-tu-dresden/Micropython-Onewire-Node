<!DOCTYPE html><html lang="en"><meta charset="utf-8"><title>LoPy4 Config</title><meta name="description" content="Small website to config and control the lopy."><meta name="author" content="Karl Wolffgang"><meta name="viewport" content="width=device-width,initial-scale=1"><link href="http://fonts.googleapis.com/css?family=Raleway:400,300,600" rel="stylesheet" type="text/css"><link rel="stylesheet" href="css/normalize.css"><link rel="stylesheet" href="css/skeleton.css"><link rel="stylesheet" href="css/costum.css"><div class="container"><div class="row"><h2 class="eleven columns" id="top_headline">GEWV Lora Node <b id="dev_eui"></b></h2></div><hr class="underline_hr"><div class="row"><button class="button button-icon u-pull-right" id="reloadButton" onclick="handleReloadClick()">&#x21bb;</button></div><div class="row"><div class="three columns"><div class="row"><button id="button_1" class="button-primary" onclick="handleNavButtonClick(1)" style="width: 100%;">Sensoren</button></div><div class="row"><button id="button_2" onclick="handleNavButtonClick(2)" style="width: 100%;">Status</button></div><div class="row"><button id="button_3" onclick="handleNavButtonClick(3)" style="width: 100%;">Lora</button></div></div><div id="content" class="nine columns"></div></div></div><template id="status_template"><div id="status_container" class="container"><h3>Status</h3><script></script></div></template><template id="sensors_template"><div id="sensors_container" class="container"><table id="sensor_table" class="u-full-width"><thead><tr><th>Name<th>Adress<th>Value<tbody id="sensors_table_body"></tbody><table></table></table></div></template><template id="lora_template"><div id="lora_container" class="container"><label for="dev_eui_form">Device EUI</label> <input class="u-full-width" id="dev_eui_form"> <label for="app_eui_form">App EUI</label> <input class="u-full-width" id="app_eui_form"> <label for="app_key_form">App Key</label> <input class="u-full-width" type="password" value="123456789" id="app_key_form"></div></template><script>// CONSTANTS
  const VIEWS = {
    sensors : 1,
    status: 2,
    lora: 3,
  }
  let state = {
    view: VIEWS.sensors,
  }

  // FUNCTIONS
  loadView = (view_id) => {
    const links = document.querySelectorAll('template');
    let template = null
    const targetView = Object.keys(VIEWS).find(key => VIEWS[key] === view_id);

    links.forEach(element => {
      const id = element.id.replace('_template', '')

      if (id === targetView) {
        template = element
      }
    })

    if (template != null) {
      // Clone the <template> in the import.
      const clone = document.importNode(template.content, true);
      const content = document.querySelector('#content')

      while (content.firstChild) {
          content.firstChild.remove();
      }
      content.appendChild(clone);
    }
  }

  handleNavButtonClick = (view_id) => {
    state = Object.assign({}, state, {
      view: view_id,
    })

    loadView(view_id)
    document.querySelectorAll('button').forEach(element => element.classList.remove('button-primary'))
    document.querySelector('#button_' + view_id).classList.toggle('button-primary')
  }

  buildSensorsTable = (sensors) => {
    const tbody = document.createElement('tbody')
    tbody.id = 'sensors_table_body'

    for (const [name, sensor] of Object.entries(sensors)) {
      const nameCell = document.createElement('td')
      nameCell.innerHTML = name
      const addressCell = document.createElement('td')
      addressCell.innerHTML = sensor[0]
      const valueCell = document.createElement('td')
      valueCell.innerHTML = sensor[1]

      const row = document.createElement('tr')
      row.appendChild(nameCell)
      row.appendChild(addressCell)
      row.appendChild(valueCell)
      tbody.appendChild(row)
    }

    return tbody
  }

  loadState = async () => {
    try {
      res = await fetch('state')
      deviceState = await res.json()

      if (state != null) {
        document.querySelector('#dev_eui').innerHTML = deviceState.dev_eui

        // list sensors
        const sensorsTemplate = document.querySelector('#sensors_template').content
        const sensorTable = sensorsTemplate.querySelector('#sensor_table')
        const tableBody = sensorsTemplate.querySelector('#sensors_table_body')
        const newTableBody = buildSensorsTable(deviceState.sensors)
        sensorTable.replaceChild(newTableBody, tableBody)

        // modify lora forms
        const loraTemplate = document.querySelector('#lora_template').content
        loraTemplate.querySelector('#dev_eui_form').value = deviceState.dev_eui
        loraTemplate.querySelector('#app_eui_form').value = deviceState.app_eui

      }
    } catch (err) {
      console.error(`Failed to fetch state: ${err}`)
    }
  }

  handleReloadClick = async () => {
    await loadState()
    loadView(state.view)
  }

  document.addEventListener("DOMContentLoaded", async (event) => {
    await loadState()
    loadView(state.view)
  });</script>